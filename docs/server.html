<!DOCTYPE html>  <html> <head>   <title>server.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="chat.html">                 chat.coffee               </a>                                           <a class="source" href="collections.html">                 collections.coffee               </a>                                           <a class="source" href="itpirl.html">                 itpirl.coffee               </a>                                           <a class="source" href="models.html">                 models.coffee               </a>                                           <a class="source" href="routers.html">                 routers.coffee               </a>                                           <a class="source" href="utils.html">                 utils.coffee               </a>                                           <a class="source" href="views.html">                 views.coffee               </a>                                           <a class="source" href="helpers.html">                 helpers.coffee               </a>                                           <a class="source" href="server.html">                 server.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               server.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h2>REQUIRE MODULES</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">http = </span><span class="nx">require</span> <span class="s1">&#39;http&#39;</span> <span class="c1"># posting to cakemix</span>
<span class="nv">querystring = </span><span class="nx">require</span> <span class="s1">&#39;querystring&#39;</span> <span class="c1"># stringifying posts to cakemix</span>
<span class="nv">nowjs = </span><span class="nx">require</span> <span class="s1">&#39;now&#39;</span>
<span class="nv">express = </span><span class="nx">require</span> <span class="s1">&#39;express&#39;</span>
<span class="nv">irc = </span><span class="nx">require</span> <span class="s1">&#39;irc&#39;</span> <span class="c1"># irc client for node.js</span>
<span class="nv">mustache = </span><span class="nx">require</span> <span class="s1">&#39;mustache&#39;</span> <span class="c1"># templating</span>
<span class="nv">ejs = </span><span class="nx">require</span> <span class="s1">&#39;ejs&#39;</span> <span class="c1"># templating</span>
<span class="nv">redis = </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;redis-url&#39;</span><span class="p">).</span><span class="nx">connect</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">REDISTOGO_URL</span> <span class="o">||</span> <span class="s1">&#39;redis://localhost:6379&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Load other files.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">helpers = </span><span class="nx">require</span> <span class="s1">&#39;./helpers.js&#39;</span>

<span class="nv">ircConnections = </span><span class="p">{}</span>
<span class="nv">ircHost = </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">ITPIRL_IRC_HOST</span> <span class="o">||</span> <span class="s1">&#39;irc.freenode.net&#39;</span>

<span class="k">class</span> <span class="nx">ircBridge</span>
  <span class="nv">constructor: </span><span class="nf">(@name, callback) -&gt;</span>
    <span class="vi">@client = </span><span class="k">new</span> <span class="nx">irc</span><span class="p">.</span><span class="nx">Client</span> <span class="nx">ircHost</span><span class="p">,</span> <span class="nx">@name</span><span class="p">,</span>
      <span class="nv">channels: </span><span class="p">[</span><span class="s1">&#39;#itp&#39;</span><span class="p">]</span>
      <span class="nv">port: </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">ITPIRL_IRC_PORT</span> <span class="o">||</span> <span class="mi">6667</span>
      <span class="nv">autoConnect: </span><span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Listen for IRC events relating to this user.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@client</span><span class="p">.</span><span class="nx">addListener</span> <span class="s1">&#39;pm&#39;</span><span class="p">,</span> <span class="nf">(from, message) -&gt;</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;PRIVATE MESSAGE FROM: #{from}:&quot;</span><span class="p">,</span> <span class="nx">message</span>
    <span class="nx">@client</span><span class="p">.</span><span class="nx">addListener</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nf">(message) -&gt;</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;ERROR:&quot;</span><span class="p">,</span> <span class="nx">message</span>
    <span class="nx">@client</span><span class="p">.</span><span class="nx">addListener</span> <span class="s1">&#39;notice&#39;</span><span class="p">,</span> <span class="nf">(nick, to, text, message) -&gt;</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;NOTICE: #{nick}: #{to} : #{text} : #{message}&quot;</span>
    <span class="nx">@client</span><span class="p">.</span><span class="nx">addListener</span> <span class="s1">&#39;names&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="nx">nicks</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Tell Now.js what your actual name is.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">callback</span><span class="p">(</span><span class="nx">@client</span><span class="p">.</span><span class="nx">nick</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h2>SETUP EXPRESS APP</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">app = </span><span class="nx">express</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">logger</span><span class="p">())</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">configure</span> <span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Setup static file server</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span> <span class="nx">express</span><span class="p">.</span><span class="nx">static</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/public&#39;</span><span class="p">)</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span> <span class="nx">express</span><span class="p">.</span><span class="nx">bodyParser</span><span class="p">()</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="s2">&quot;.mustache&quot;</span><span class="p">,</span> <span class="nx">helpers</span><span class="p">.</span><span class="nx">mustache_template</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h2>ROUTES</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nf">(request, response) -&gt;</span>
  <span class="nx">response</span><span class="p">.</span><span class="nx">render</span> <span class="s1">&#39;index.ejs&#39;</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;/help&#39;</span><span class="p">,</span> <span class="nf">(request, response) -&gt;</span>
  <span class="nx">response</span><span class="p">.</span><span class="nx">send</span> <span class="s1">&#39;Hello World&#39;</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">post</span> <span class="s1">&#39;/feedback/new&#39;</span><span class="p">,</span> <span class="nf">(request, response) -&gt;</span>
  <span class="nx">logMessage</span> <span class="nx">request</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">(),</span> <span class="s1">&#39;itpirl-feedback&#39;</span>
  <span class="nx">response</span><span class="p">.</span><span class="nx">send</span> <span class="s1">&#39;{sucess:hopefully}&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <h2>SETUP NOW.JS</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">everyone = </span><span class="nx">nowjs</span><span class="p">.</span><span class="nx">initialize</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="p">{</span><span class="nv">socketio: </span><span class="p">{</span><span class="nx">transports</span><span class="o">:</span><span class="p">[</span><span class="s1">&#39;xhr-polling&#39;</span><span class="p">,</span><span class="s1">&#39;jsonp-polling&#39;</span><span class="p">]}})</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <h2>LOGGING MESSAGES TO REDIS</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <h4>LogMessage</h4>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">logMessage = </span><span class="nf">(timestamp, sender, message, destination={&#39;room&#39;:&#39;itp&#39;}) -&gt;</span>
  <span class="nx">redis</span><span class="p">.</span><span class="nx">incr</span> <span class="s1">&#39;nextId&#39;</span><span class="p">,</span> <span class="nf">(err,id) -&gt;</span>
    <span class="nv">newMessage = </span><span class="p">{</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">sender</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">destination</span><span class="p">,</span> <span class="nx">timestamp</span> <span class="p">}</span>
    <span class="nx">redis</span><span class="p">.</span><span class="nx">rpush</span> <span class="s1">&#39;messages:&#39;</span><span class="o">+</span><span class="nx">destination</span><span class="p">.</span><span class="nx">room</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">newMessage</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <h4>Log and Forward</h4>

<p>Log a message and send it out via a Now.js function. I found myself writing
these three lines often and got tired of it.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">logAndForward = </span><span class="nf">(sender, message, destination={&#39;room&#39;:&#39;itp&#39;}, callback) -&gt;</span>
  <span class="nv">timestamp = </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span>
  <span class="nx">logMessage</span> <span class="nx">timestamp</span><span class="p">,</span> <span class="nx">sender</span><span class="p">,</span> <span class="nx">message</span>
  <span class="nx">callback</span><span class="p">(</span><span class="nx">timestamp</span><span class="p">,</span> <span class="nx">sender</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <h2>NOW CHAT</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <h3>Chat Messages</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>A Chat message is initiated by textual input from a client. This includes
all humans and bots. Chat messages are simple, they have a sender name,
a content and an optional destination. The default destination is the main
room #itp. The value of the destination is based on the current state of the
client. Chat messages are assigned timestamps by the server to avoid any
problems with clients' clocks or system lag.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Triggered when a Now.js client sends a message. Simply forwards the message
to IRC. Currently no method for sending direct messages. And that's ok...for
now. At least until I get ircClients happening per client.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">everyone.now.distributeChatMessage = </span><span class="nf">(sender, message, destination={&#39;room&#39;:&#39;itp&#39;}) -&gt;</span>
  <span class="nx">ircConnections</span><span class="p">[</span><span class="nx">@user</span><span class="p">.</span><span class="nx">clientId</span><span class="p">].</span><span class="nx">client</span><span class="p">.</span><span class="nx">say</span><span class="p">(</span><span class="s2">&quot;##{destination.room}&quot;</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Check to see</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">@now</span><span class="p">.</span><span class="nx">serverChangedName</span> <span class="nx">ircConnections</span><span class="p">[</span><span class="nx">@user</span><span class="p">.</span><span class="nx">clientId</span><span class="p">].</span><span class="nx">client</span><span class="p">.</span><span class="nx">nick</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <h3>System Messages</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>A System message is initiated by the server. Client actions can trigger a
System message but cannot initiate their own system message... I think.
Timestamps are set by this method.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>System Message Types:
- Join
- Leave
- NickChange
- Bulletin</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>I NEED TO BE SURE THIS METHOD IS PRIVATE</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <pre><code> { type:MESSAGE_TYPE,
   message: MESSAGE_BODY,
   destination: {
     room:____
     XOR
     name:____ &lt;- is this better to be a name or a clientID?
   }
 }
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">everyone.now.distributeSystemMessage = </span><span class="nf">(type, message, destination={&#39;room&#39;:&#39;itp&#39;})  -&gt;</span>
  <span class="nv">timestamp = </span><span class="nx">helpers</span><span class="p">.</span><span class="nx">setTimestamp</span><span class="p">()</span>
  <span class="nx">logMessage</span> <span class="nx">timestamp</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">destination</span>
  <span class="nx">everyone</span><span class="p">.</span><span class="nx">now</span><span class="p">.</span><span class="nx">receiveSystemMessage</span> <span class="nx">timestamp</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">message</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Get the names of all connected Now.js clientss</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">everyone.now.getUserList = </span><span class="o">-&gt;</span>
  <span class="nv">everyone.now.userList = </span><span class="p">[]</span>
  <span class="nx">everyone</span><span class="p">.</span><span class="nx">getUsers</span> <span class="nf">(users) -&gt;</span>
    <span class="k">for</span> <span class="nx">user</span> <span class="k">in</span> <span class="nx">users</span>
      <span class="nx">nowjs</span><span class="p">.</span><span class="nx">getClient</span> <span class="nx">user</span><span class="p">,</span> <span class="o">-&gt;</span>
        <span class="nx">everyone</span><span class="p">.</span><span class="nx">now</span><span class="p">.</span><span class="nx">addUserToList</span> <span class="nx">@now</span><span class="p">.</span><span class="nx">name</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Propogate name change to IRC and send out a message.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">everyone.now.changeNick = </span><span class="nf">(oldNick, newNick) -&gt;</span>
  <span class="nx">ircConnections</span><span class="p">[</span><span class="nx">@user</span><span class="p">.</span><span class="nx">clientId</span><span class="p">].</span><span class="nv">client.nick = </span><span class="nx">newNick</span>
  <span class="nx">ircConnections</span><span class="p">[</span><span class="nx">@user</span><span class="p">.</span><span class="nx">clientId</span><span class="p">].</span><span class="nx">client</span><span class="p">.</span><span class="nx">send</span> <span class="s2">&quot;NICK #{newNick}&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <h3>Connecting to Now.js</h3>

<p>On the connect event create an <code>ircBridge</code> for the new user with <code>@now.name</code>
and log to Redis that a new user has joined.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">nowjs</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;connect&#39;</span><span class="p">,</span> <span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Create an ircBridge object for the new user. And tell everyone there is a
new user.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">myNow = </span><span class="nx">@now</span>
  <span class="nx">ircConnections</span><span class="p">[</span><span class="nx">@user</span><span class="p">.</span><span class="nx">clientId</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ircBridge</span> <span class="nx">@now</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nf">(name) -&gt;</span>
    <span class="nv">myNow.name = </span><span class="nx">name</span>
    <span class="nx">myNow</span><span class="p">.</span><span class="nx">serverChangedName</span> <span class="nx">name</span>
  <span class="nx">logAndForward</span> <span class="s1">&#39;Join&#39;</span><span class="p">,</span> <span class="s2">&quot;#{@now.name} has joined the chat.&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;room&#39;</span><span class="o">:</span><span class="s1">&#39;itp&#39;</span><span class="p">},</span> <span class="nx">everyone</span><span class="p">.</span><span class="nx">now</span><span class="p">.</span><span class="nx">receiveSystemMessage</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Get recent messages from Redis and send them only to this user.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">myNow = </span><span class="nx">@now</span>
  <span class="nv">room = </span><span class="s1">&#39;itp&#39;</span>

  <span class="nx">redis</span><span class="p">.</span><span class="nx">llen</span> <span class="s1">&#39;messages:&#39;</span> <span class="o">+</span> <span class="nx">room</span><span class="p">,</span> <span class="nf">(err, length) -&gt;</span>
    <span class="nv">start = </span><span class="nx">length</span> <span class="o">-</span> <span class="mi">10</span>
    <span class="nv">end = </span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="nx">redis</span><span class="p">.</span><span class="nx">lrange</span> <span class="s1">&#39;messages:&#39;</span> <span class="o">+</span> <span class="nx">room</span><span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">end</span><span class="p">,</span> <span class="nf">(err, obj) -&gt;</span>
      <span class="k">for</span> <span class="nx">message</span> <span class="k">in</span> <span class="nx">obj</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Redis returns the object as a string, turn it back to an object</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">m = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Send these previous messages to the client</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">myNow</span><span class="p">.</span><span class="nx">receivePreviousMessage</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span>

<span class="nx">nowjs</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;disconnect&#39;</span><span class="p">,</span> <span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Disconnect that user from IRC.
I PROBABLY NEED TO DESTROY THIS OBJECT?</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">ircConnections</span><span class="p">[</span><span class="nx">@user</span><span class="p">.</span><span class="nx">clientId</span><span class="p">].</span><span class="nx">client</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">(</span><span class="s1">&#39;seeya&#39;</span><span class="p">)</span>
  <span class="nx">logAndForward</span> <span class="s1">&#39;Leave&#39;</span><span class="p">,</span> <span class="s2">&quot;#{@now.name} has left the chat.&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;room&#39;</span><span class="o">:</span><span class="s1">&#39;itp&#39;</span><span class="p">},</span> <span class="nx">everyone</span><span class="p">.</span><span class="nx">now</span><span class="p">.</span><span class="nx">receiveSystemMessage</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <h2>SETUP IRC ON NODE.JS SERVER</h2>

<p>Create an IRC client for the server. Though many clients can speak to IRC
I only want one client listening for non-system messages to prevent sending
and logging messages multiple times.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">ircNick = </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">ITPIRL_IRC_NICK</span> <span class="o">||</span> <span class="s1">&#39;itpirl_server&#39;</span>
<span class="nv">everyone.ircClient = </span><span class="k">new</span> <span class="nx">irc</span><span class="p">.</span><span class="nx">Client</span> <span class="nx">ircHost</span><span class="p">,</span> <span class="nx">ircNick</span><span class="p">,</span>
  <span class="nv">channels: </span><span class="p">[</span><span class="s1">&#39;#itp&#39;</span><span class="p">]</span>
  <span class="nv">port: </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">ITPIRL_IRC_PORT</span> <span class="o">||</span> <span class="mi">6667</span>
  <span class="nv">autoConnect: </span><span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>userName: process.env.ITPIRL<em>IRC</em>USERNAME || ''
password: process.env.ITPIRL<em>IRC</em>PASSWORD || ''</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Nick change notifications go to everyone and since some people may sign in
with IRC directly and not via itpirl.com if each client listens for nick
changes the log will just get super huge. Let's only listen for these on the
server account.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">everyone</span><span class="p">.</span><span class="nx">ircClient</span><span class="p">.</span><span class="nx">addListener</span> <span class="s1">&#39;nick&#39;</span><span class="p">,</span> <span class="nf">(oldnick, newnick, channels, message) -&gt;</span>
  <span class="nx">logAndForward</span> <span class="s1">&#39;NICK&#39;</span><span class="p">,</span> <span class="s2">&quot;#{oldnick} is now known as #{newnick}&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;room&#39;</span><span class="o">:</span><span class="s1">&#39;itp&#39;</span><span class="p">},</span> <span class="nx">everyone</span><span class="p">.</span><span class="nx">now</span><span class="p">.</span><span class="nx">receiveSystemMessage</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>everyone.ircClient.addListener 'names', (channel, nicks) ->
  console.log channel, nicks
everyone.ircClient.addListener 'notice', (nick, to, text, message) ->
  console.log "Notice", "#{nick}: #{to} : #{text} : #{message}"</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Listen for messages to the ITP room and send them to Now.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">everyone</span><span class="p">.</span><span class="nx">ircClient</span><span class="p">.</span><span class="nx">addListener</span> <span class="s1">&#39;message#itp&#39;</span><span class="p">,</span> <span class="nf">(from, message) -&gt;</span>
  <span class="nx">logAndForward</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;room&#39;</span><span class="o">:</span><span class="s1">&#39;itp&#39;</span><span class="p">},</span> <span class="nx">everyone</span><span class="p">.</span><span class="nx">now</span><span class="p">.</span><span class="nx">receiveChatMessage</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <h2>LISTEN ON A PORT</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">port = </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span> <span class="o">||</span> <span class="mi">3000</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span> <span class="nx">port</span><span class="p">,</span> <span class="o">-&gt;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Listening on &quot;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">)</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 